# Решение проблемы 401 с Vercel Authentication

## Проблема

Vercel Authentication блокирует **все** запросы до того, как они доходят до приложения. Это означает, что даже с валидным токеном в URL, запросы все равно возвращают 401.

## Почему это происходит

Vercel Authentication работает на уровне инфраструктуры Vercel, **до** вашего кода. Он проверяет авторизацию до того, как запрос доходит до:
- Вашего приложения
- Edge Functions
- Middleware
- API routes

## Решение для Vite проекта

Для **Vite проекта** (не Next.js) есть только один способ решить проблему:

### ✅ ОТКЛЮЧИТЬ ЗАЩИТУ ДЕПЛОЯ

**Где искать:**

#### Вариант 1: Deployment Protection
1. Зайдите на https://vercel.com
2. Выберите проект `delever-site`
3. В левом меню: **Build and Deployment** → **Deployment Protection**
4. Отключите все переключатели защиты

#### Вариант 2: General Settings
1. В левом меню: **General**
2. Прокрутите вниз до **Deployment Protection**
3. Отключите все опции

#### Вариант 3: Team Settings (если проект в команде)
1. Нажмите на название команды вверху
2. **Settings** команды → **Security**
3. Проверьте настройки на уровне команды

### Почему это безопасно?

1. **Сайт публичный** - не требует авторизации для просмотра
2. **Токен защищает доступ** - параметр `admin_token` все равно проверяется
3. **Админка защищена** - имеет свою систему авторизации
4. **Минимальная защита** - только те, кто знает токен, могут редактировать

### Альтернатива: Использовать другой метод защиты

Если нужно оставить защиту, можно:

1. **Использовать Vercel Password Protection** вместо Authentication
   - Это позволяет добавить исключения для определенных путей
   - Но все равно может блокировать iframe

2. **Создать отдельный проект без защиты**
   - Создать `preview.delever.io` без Vercel Authentication
   - Использовать его для админки

3. **Использовать Cloudflare Access** или другой сервис
   - Более гибкая настройка исключений

## Проверка после отключения

После отключения Vercel Authentication:

1. **Проверьте URL напрямую:**
   ```
   https://delever-site-...vercel.app/?admin_token=ВАШ_ТОКЕН&edit_mode=true
   ```
   Должен открыться без 401 ошибки

2. **Проверьте в админке:**
   - Откройте админку → Редактор
   - Сайт должен загрузиться в iframe
   - Элементы должны автоматически загрузиться

3. **Проверьте токен:**
   - Откройте Network tab
   - URL должен содержать ваш токен
   - Статус должен быть 200 OK

## Если все еще 401

Если после отключения Vercel Authentication все еще получаете 401:

1. **Проверьте переменные окружения:**
   - Убедитесь, что `ADMIN_EDIT_TOKEN` добавлен на сайте
   - Убедитесь, что `VITE_ADMIN_EDIT_TOKEN` добавлен в админке
   - Токены должны быть **одинаковые**

2. **Проверьте деплой:**
   - Убедитесь, что проекты передеплоены после добавления переменных
   - Проверьте логи деплоя на ошибки

3. **Проверьте токен в URL:**
   - Откройте консоль браузера в админке
   - Проверьте, какой токен передается в URL
   - Сравните с токеном в переменных окружения

## Итог

**Для Vite проекта единственное решение - отключить Vercel Authentication.**

Токен `admin_token` все равно обеспечивает минимальную защиту, так как только те, кто знает токен, могут получить доступ к редактированию.

