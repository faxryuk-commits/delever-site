# Решение проблемы 401 Unauthorized

## Проблема

Даже после добавления токенов в переменные окружения, сайт все еще возвращает `401 Unauthorized`.

## Причина

**Vercel Authentication** блокирует запросы **ДО** того, как они доходят до приложения или Edge Functions. Это означает, что наши проверки токена не срабатывают.

## Решение

### Вариант 1: Отключить Vercel Authentication (РЕКОМЕНДУЕТСЯ)

Vercel Authentication блокирует все запросы, включая запросы с валидным токеном. Для публичного сайта это избыточно.

**Шаги:**
1. Зайдите на https://vercel.com
2. Выберите проект `delever-site`
3. Перейдите в **Settings** → **Authentication**
4. **Отключите Vercel Authentication** или удалите защиту проекта

**Почему это безопасно:**
- Сайт публичный и не требует авторизации для просмотра
- Админка имеет свою систему авторизации
- Токен `admin_token` все равно защищает доступ для редактирования

### Вариант 2: Использовать обходной путь через API

Если нельзя отключить Vercel Authentication, создайте специальный endpoint:

1. Создайте `/api/preview` endpoint, который не требует Vercel Authentication
2. Этот endpoint будет проверять токен и возвращать HTML
3. Обновите админку для использования этого endpoint

Но это сложнее и требует серверного рендеринга.

### Вариант 3: Проверить настройки Vercel Authentication

Если Vercel Authentication настроен, проверьте:
1. Можно ли добавить исключения для определенных путей?
2. Можно ли отключить для preview deployments?
3. Есть ли возможность использовать другой метод авторизации?

## Проверка токенов

Убедитесь, что токены настроены правильно:

### В админке:
- Переменная: `VITE_ADMIN_EDIT_TOKEN`
- Значение: ваш токен (например, `a1b2c3d4e5f6...`)

### На сайте:
- Переменная: `ADMIN_EDIT_TOKEN`
- Значение: **тот же токен**, что и в админке

### Проверка в коде:

Откройте консоль браузера в админке и выполните:
```javascript
console.log('Token:', import.meta.env.VITE_ADMIN_EDIT_TOKEN)
```

Должен показать ваш токен (если не в продакшене, может быть undefined).

## Отладка

1. **Проверьте URL в Network tab:**
   - Должен содержать `?admin_token=ВАШ_ТОКЕН&edit_mode=true`
   - Токен должен совпадать с переменной окружения

2. **Проверьте переменные окружения:**
   - В Vercel → Settings → Environment Variables
   - Убедитесь, что переменные добавлены для всех окружений (Production, Preview, Development)

3. **Проверьте логи Vercel:**
   - В Vercel → Deployments → выберите последний деплой → Logs
   - Ищите ошибки или предупреждения

4. **Проверьте Edge Function:**
   - Откройте: `https://delever-site-...vercel.app/api/verify-admin?admin_token=ВАШ_ТОКЕН&edit_mode=true`
   - Должен вернуть `{"authorized": true}`

## Быстрое решение

**Самый простой способ:** Отключите Vercel Authentication в настройках проекта. Это решит проблему сразу.

После отключения:
- Сайт будет доступен без 401 ошибки
- Токен `admin_token` все равно будет защищать доступ
- Админка сможет загружать сайт в iframe

